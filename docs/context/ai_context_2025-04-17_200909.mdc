# AI Context Document - New Chat Protocol Initiation
Date: Thu 04/17/2025 20:09:09.63

## Overview

This document summarizes the system state and context established following the `speciality/new_chat_protocol.mdc` as of the date/time above. It incorporates findings from protocol execution and previous context documents.

## Project Structure & Key Components

*   **Goal:** Web UI (React/Vite/Tailwind in `src/`) for users to create, configure, and manage AI agents that interact on Discord.
*   **Backend:**
    *   Supabase (`supabase/`): Database (`agents`, `agent_discord_connections`), Authentication, Edge Functions (`manage-discord-worker`, `discord-interaction-handler`, `update-enabled-guilds`, etc.).
    *   Worker Services (`services/`): Node.js/TypeScript services running on DigitalOcean, managed by PM2.
        *   `worker-manager`: Manages worker processes via PM2 API.
        *   `discord-worker`: Individual Discord bot instances connecting to Discord Gateway.
*   **Documentation:** `README.md`, `docs/index.md`, `docs/context/`, `docs/bugs/`, `.cursor/rules/`.
*   **Configuration:** `package.json`, `.env` (root), `tsconfig*.json`, Vite/PostCSS/Tailwind configs, `ecosystem.config.js` (PM2).

## Analysis Findings (New Chat Protocol)

*   **Core Files:** Identified key UI components (`AgentEdit`, `DiscordConnect`, `GuildSelectionModal`), Supabase Functions (`manage-discord-worker`, `discord-interaction-handler`, `update-enabled-guilds`), and Worker Services (`worker-manager`, `discord-worker`).
*   **Database Schema:** Key tables are `agents` and `agent_discord_connections`. Multi-guild support enabled by removing `agent_id` unique constraint on connections table (`20250417233755_...sql`). RLS policies (`20250417174024_...sql`) exist but are **currently disabled** on these tables. Worker status updates utilize the `update_worker_status` SECURITY DEFINER RPC function.
*   **API Endpoints/Entry Points:**
    *   UI (Vite dev server via `index.html` -> `src/page.tsx`)
    *   Supabase Edge Functions (HTTP triggers from UI/Discord)
    *   `worker-manager` service (PM2-managed Node server, likely receives HTTP from Supabase)
    *   `discord-worker` (PM2-managed Node client, connects outbound to Discord Gateway)
*   **Logs (`docs/console/logs/`):** Directory **missing**. Violation of RULE #2. Temporary logs were previously in `logs.txt` (root).
*   **Bugs (`docs/bugs/`):** Contains `discord-interaction-handler.md` (Supabase logs for that function), no formal bug reports.

## Current State & Recent Progress (from Conversation History & Previous Context)

*   Core agent activation/deactivation workflow (UI -> Supabase Function -> Worker Manager -> Discord Worker) is functional.
*   UI/UX improvements made to `GuildSelectionModal` (save confirmation, error handling) and `AgentEdit` (optimized activation/deactivation updates via polling `pollWorkerStatus`).
*   CORS issue fixed for saving enabled guilds (`update-enabled-guilds` function).
*   RLS issues previously resolved by implementing `update_worker_status` RPC, but RLS was subsequently **disabled** for `agents` and `agent_discord_connections`.

## Discrepancies & Potential Issues

*   **Missing Log Directory:** Standard logging needs implementation per RULE #2.
*   **RLS Disabled:** Needs re-enabling and verification, relying on the RPC function for worker updates.
*   **Outdated Docs?:** `docs/index.md` might list incorrect frontend entry points (`main.tsx`/`App.tsx` vs `page.tsx`).
*   **Cleanup:** Potential remaining diagnostic code from previous debugging.

## Recommendations for Next Steps

1.  **Verify UI Fixes:** Thoroughly test `GuildSelectionModal` confirmation and `AgentEdit` activation/deactivation smoothness.
2.  **Re-enable RLS:** In Supabase dashboard for `agent_discord_connections` and `agents`. Verify system function relies on `update_worker_status` RPC.
3.  **Establish Logging:** Create `docs/console/logs/` and implement standard logging in backend services/functions.
4.  **Code Cleanup:** Remove any temporary diagnostic logs or code.
5.  **Documentation Update:** Verify/correct entry points listed in `docs/index.md`.

---
Generated by AI Assistant following `speciality/new_chat_protocol.mdc` at Thu 04/17/2025 20:09:09.63 