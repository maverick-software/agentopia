# AI Context Document - New Chat Protocol Initiation
Date: Mon 04/14/2025  5:56:37.20

## Overview

This document summarizes the system state and context established following the `speciality/new_chat_protocol.mdc`. The primary goal is to understand the project structure, current progress, and identify immediate next steps for the Agentopia Discord Bot integration.

## Project Structure & Key Components

The project integrates Agentopia agents with Discord using a multi-component architecture:

*   **Frontend (React/Vite/Tailwind):** Located in `src/`, provides UI for users to configure agent Discord settings (Bot Token, App ID, Public Key) via `AgentEdit.tsx` and `DiscordConnect.tsx`.
*   **Backend (Supabase):** Uses Supabase for database (`agents`, `agent_discord_connections` tables), authentication, and Edge Functions (`supabase/functions/`).
    *   `register-agent-commands`: Registers Discord slash commands (`/activate`).
    *   `discord-interaction-handler`: Handles incoming Discord webhooks (slash commands, autocomplete), verifies signatures, and triggers the worker manager.
*   **Worker Services (Node.js/TypeScript):** Located in `services/`.
    *   `worker-manager`: An Express server (`services/worker-manager/`) responsible for launching (`/start-worker` endpoint) and managing `discord-worker` instances via `child_process.spawn`. Authenticated via `MANAGER_SECRET_KEY`.
    *   `discord-worker`: A `discord.js` client (`services/discord-worker/`) that connects to the Discord Gateway using an agent's token, handles inactivity timeouts, and is intended to relay messages to/from the core agent logic (via a yet-to-be-implemented `agent-core-handler`).
*   **Configuration:** Managed via `package.json`, `.env` files (root for frontend, service-specific likely), `tsconfig*.json`, `vite.config.ts`.

## Analysis Findings

*   **Documentation:** `README.md` provides a good overview. `docs/index.md` offers a basic directory structure. The `old_chat_protocol` handover summary (provided by the user) contains detailed information on progress and component interactions.
*   **Core Files:** Identified core frontend, backend (Supabase functions), and worker service files.
*   **Database:** Schema involves `agents` and `agent_discord_connections` tables, storing necessary Discord credentials, guild links, and worker status. RLS policies are applied. Migration files exist in `supabase/migrations/`.
*   **API Endpoints:**
    *   Supabase functions handle Discord interactions (`discord-interaction-handler`) and command registration (`register-agent-commands`).
    *   The `worker-manager` exposes `/start-worker` for the interaction handler.
    *   The `discord-worker` connects outbound to Discord and needs an endpoint (`agent-core-handler`) to communicate with the agent logic.
*   **Logs & Bugs:** No application logs found in the expected `docs/console/logs/` location. No bug reports found in `docs/bugs/`.
*   **Checklists:** A new checklist `docs/context/checklists/checklist_2025_04_14.md` was created based on the template. Previous context documents and checklists exist.

## Discrepancies & Potential Issues

*   **Missing Log Directory:** The standard log directory (`docs/console/logs/`) is missing, violating RULE #2. Logging needs to be established or located elsewhere.
*   **Missing `agent-core-handler`:** The `discord-worker` relies on an `agent-core-handler` function which is not yet implemented. This is critical for actual agent interaction.
*   **Guild Linking Refinement:** The handover notes the need to refine the UI and logic for selecting and using specific Guild IDs in `agent_discord_connections`. The current `/activate` command logic depends on this.
*   **Deployment Strategy:** The current `worker-manager`'s in-memory process tracking is unsuitable for production. A robust deployment and process management strategy is required.

## Known Issues (from handover)

*   UI state management, input handling, and saving/disconnecting issues were previously addressed in `AgentEdit.tsx`/`DiscordConnect.tsx`.
*   Database query issues related to column references were fixed.
*   Layout bugs (margins, overflow) were addressed.

## Entry Points

*   **User Interface:** Web application served by Vite (likely accessed via `http://localhost:port` during development). Main interaction points are `AgentEdit.tsx` and `DiscordConnect.tsx`.
*   **Discord Interaction:** Discord sends webhooks (POST requests) to the `discord-interaction-handler` Supabase function URL.
*   **Worker Management:** The `discord-interaction-handler` calls the `/start-worker` endpoint on the `worker-manager` service.

## Next Steps & Recommendations

Based on the `old_chat_protocol` handover and the `new_chat_protocol` analysis:

1.  **Integration Testing:** Test the full `/activate` flow: Discord -> `discord-interaction-handler` -> `worker-manager` -> `discord-worker`. Requires exposing the local `worker-manager`. (Aligns with Handover Step 1)
2.  **Implement `agent-core-handler`:** Create the Supabase Edge Function or other mechanism for the `discord-worker` to communicate with the core Agentopia agent logic. (Aligns with Handover Step 2)
3.  **Refine Guild Linking:** Implement the UI and backend logic for selecting/using Guild IDs in `agent_discord_connections`. (Aligns with Handover Step 3)
4.  **Establish Logging:** Create the `docs/console/logs/` directory and implement logging within the services (`worker-manager`, `discord-worker`) and potentially Supabase functions, adhering to RULE #2.
5.  **Plan Deployment Strategy:** Define how the worker services will be deployed and managed reliably. (Aligns with Handover Step 4)
6.  **Update Checklist:** Mark completed items in `docs/context/checklists/checklist_2025_04_14.md`.

---
Generated by AI Assistant following `speciality/new_chat_protocol.mdc` at Mon 04/14/2025  5:56:37.20 