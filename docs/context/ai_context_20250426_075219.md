# AI Context Document - Sat 04/26/2025 07:52:19

This document summarizes the system state and context following the execution of the `new_chat_protocol` on Sat 04/26/2025.

## Investigation Date & Time
Sat 04/26/2025 07:52:19

## Project Structure & Key Components

*   **Goal:** Agentopia - Platform for creating, managing, and interacting with AI agents, with a focus on Discord integration. Includes user management and admin features.
*   **Tech Stack:** React/Vite/TS (Frontend), Supabase (DB, Auth, Realtime, Edge Functions), Node.js/TS (Backend Services on DigitalOcean droplet `165.22.172.98`), Discord.js, PM2.
*   **Core Directories:** `src/` (Frontend), `supabase/functions/` (API Layer), `supabase/migrations/` (DB), `services/` (Backend Workers - discord-worker, worker-manager).
*   **Documentation:** `docs/` (plans, context, bugs), `README.md`.
*   **Logging:** Nominally at `logs/` and `docs/console/logs/` but currently empty.

## Database Overview

*   **Current Feature (Chat Rooms):** Actively implementing Discord-style chat rooms/channels. Migrations applied for `chat_rooms`, `chat_room_members`, and modifying `chat_messages` (renaming `session_id`->`channel_id`). Work is ongoing based on `docs/plans/chat_rooms/wbs_checklist.md`.
*   **Pending Schema:** Migrations for `user_team_memberships`, `chat_channels`, and RLS for several tables are pending per the checklist. Deprecation of old `chat_sessions` planned.
*   **Other Features:** Schema exists for Agents, Datastores (RAG), Discord connections, MCP (Multi-Cloud Proxy), User Profiles/Roles, Teams.
*   **RLS:** Enabled on key tables (`agents`, `agent_discord_connections`, `teams`, `team_members`, etc.). Verified via migration files and `README.md` notes. Specific RLS policies for the new chat features are pending.

## Current Feature Implementation Status (Chat Rooms & Channels)

*   **WBS:** `docs/plans/chat_rooms/wbs_checklist.md`
*   **Phase 1 (Database):** In Progress.
    *   Tables `chat_rooms`, `chat_room_members` created & migrated.
    *   Table `chat_messages` modified & migrated.
    *   Tables `user_team_memberships`, `chat_channels` schema defined, migrations pending.
    *   RLS policies for all new/modified tables pending or need correction.
    *   Deprecation of old tables (`chat_sessions`) pending.
*   **Phase 2 (Backend/API):** Not started.
*   **Phase 3 (Frontend UI):** Not started.
*   **Phase 4 (Testing):** Not started.
*   **Immediate Next WBS Step:** Create migration file for `user_team_memberships` table.

## Key Findings & Potential Issues

1.  **Missing Logs (Rule #2 Violation):** Log directories (`docs/console/logs/`, `logs/`) exist but contain no log files (except a `README.md` in `logs/`). Requires implementation.
2.  **Discord Interaction Error (Bug):** `docs/bugs/discord-interaction-handler.md` exists, indicating ongoing issues with Discord interactions (likely related to secrets/config mentioned in previous context).
3.  **Frontend Build Error (`AuthContext.tsx`):** Previous context/`README.md` mentioned a duplicate `isAdmin` variable declaration. Needs verification if this still prevents the frontend from running.
4.  **Large Files (Philosophy #1 Violation):** `src/pages/AgentEditPage.tsx` (1326 lines) and `src/pages/DatastoresPage.tsx` (664 lines) exceed the 500-line limit and require refactoring plans.
5.  **RLS Status Discrepancy:** `README.md` states RLS was potentially disabled and needs re-enabling for `agents`/`agent_discord_connections`, but also states RLS *is* enabled and correctly implemented. This needs clarification, potentially by checking the Supabase dashboard directly. However, migrations suggest current RLS setup is defined in code.

## Areas Requiring Further Investigation

*   Verify the status of the `AuthContext.tsx` error.
*   Investigate the root cause of the Discord interaction handler errors documented in `docs/bugs/`.
*   Clarify the actual RLS status for `agents` and `agent_discord_connections` in the Supabase dashboard vs. code definitions.
*   Confirm if logging has been implemented anywhere not immediately obvious.

## Application Entry Points

*   **Web UI:** `src/main.tsx` (served by Vite dev server or static build).
*   **Supabase Functions:** HTTPS endpoints exposed by Supabase (e.g., `discord-interaction-handler`, `manage-discord-worker`, `chat`).
*   **Backend Service (`worker-manager`):** Listens on `http://165.22.172.98:8000`.

---
Generated by AI Assistant following `new_chat_protocol` at Sat 04/26/2025 07:52:19 