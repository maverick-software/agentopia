# Task 3.2.1: Design StepManager Component Interface and Props

## Research Date: August 29, 2025

## Task Overview
Design the StepManager component interface, props structure, and integration pattern for the TaskWizardModal to support multi-step workflow management.

## Existing Modal Component Patterns Analysis

### EnhancedChannelsModal Pattern
- **Architecture**: Main modal with extracted sub-components
- **State Management**: Custom hooks for modal state and data operations
- **Component Structure**: 
  - Main orchestrator component (EnhancedChannelsModalRefactored.tsx)
  - Specialized list components (ConnectedChannelsList, AvailableChannelsList)
  - Card components for individual items (ChannelSetupCard)
  - Form components for setup flows (ChannelSetupForms)
  - Custom hooks for state (useChannelsModalState, useChannelPermissions)

### TaskWizardModal Current Structure
- **Step-based wizard**: 6 steps with conditional navigation
- **Modern UI**: Gradient backgrounds, step indicators with icons/colors
- **State Management**: Local useState for form data
- **Validation**: Step-by-step validation before progression
- **Visual Design**: Professional cards with hover effects and animations

### Key Design Patterns
1. **Modular Components**: Extract complex logic into focused components
2. **Custom Hooks**: Separate data fetching and state management
3. **Render Props**: Flexible component composition
4. **Conditional Rendering**: Dynamic UI based on state
5. **Professional Styling**: Gradient backgrounds, shadows, animations

## StepManager Component Design

### 1. Component Interface
```typescript
interface StepManagerProps {
  // Core data
  taskId?: string;                    // For editing existing tasks
  initialSteps?: TaskStep[];          // Pre-populated steps
  
  // Callbacks
  onStepsChange: (steps: TaskStep[]) => void;
  onValidationChange: (isValid: boolean) => void;
  
  // UI state
  isEditing?: boolean;
  disabled?: boolean;
  
  // Agent context
  agentId: string;
  agentName?: string;
  
  // Styling
  className?: string;
}

interface TaskStep {
  id: string;
  stepOrder: number;
  stepName: string;
  instructions: string;
  includePreviousContext: boolean;
  contextData?: any;
  status: 'pending' | 'running' | 'completed' | 'failed' | 'skipped';
  executionResult?: any;
}
```

### 2. Component Architecture
```
StepManager (280 lines)
├── Header Section (~30 lines)
│   ├── Title and description
│   └── Add Step button
├── StepList Component (~100 lines)
│   ├── Drag-and-drop container
│   ├── Empty state display
│   └── Step validation feedback
├── Step Items (~120 lines)
│   ├── StepCard components
│   ├── Inline editing mode
│   └── Context toggle controls
└── Footer Actions (~30 lines)
    ├── Validation summary
    └── Bulk operations
```

### 3. Integration with TaskWizardModal
```typescript
// In TaskWizardModal.tsx - Step 4 replacement
{currentStep === 4 && (
  <div className="space-y-6">
    <div className="text-center">
      <h3 className="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-2">
        Configure Task Steps
      </h3>
      <p className="text-sm text-gray-600 dark:text-gray-400">
        Break down your task into sequential steps with individual instructions
      </p>
    </div>
    
    <StepManager
      taskId={undefined} // New task
      initialSteps={taskSteps}
      onStepsChange={setTaskSteps}
      onValidationChange={setStepsValid}
      agentId={agentId}
      agentName={agentData?.name}
      className="min-h-[400px]"
    />
  </div>
)}
```

### 4. State Management Hook
```typescript
// useStepManager.ts (~200 lines)
interface UseStepManagerOptions {
  initialSteps?: TaskStep[];
  onStepsChange?: (steps: TaskStep[]) => void;
  validateSteps?: boolean;
}

export function useStepManager(options: UseStepManagerOptions) {
  const [steps, setSteps] = useState<TaskStep[]>(options.initialSteps || []);
  const [draggedStep, setDraggedStep] = useState<string | null>(null);
  const [editingStep, setEditingStep] = useState<string | null>(null);
  const [validationErrors, setValidationErrors] = useState<Record<string, string[]>>({});
  
  // Step CRUD operations
  const addStep = useCallback((stepData: Partial<TaskStep>) => { ... });
  const updateStep = useCallback((stepId: string, updates: Partial<TaskStep>) => { ... });
  const deleteStep = useCallback((stepId: string) => { ... });
  const reorderSteps = useCallback((fromIndex: number, toIndex: number) => { ... });
  
  // Validation
  const validateAllSteps = useCallback(() => { ... });
  const isValid = useMemo(() => Object.keys(validationErrors).length === 0, [validationErrors]);
  
  return {
    steps,
    draggedStep,
    editingStep,
    validationErrors,
    isValid,
    addStep,
    updateStep,
    deleteStep,
    reorderSteps,
    setEditingStep,
    setDraggedStep,
    validateAllSteps
  };
}
```

## Sub-Component Designs

### 1. StepList Component (~200 lines)
```typescript
interface StepListProps {
  steps: TaskStep[];
  editingStep: string | null;
  draggedStep: string | null;
  validationErrors: Record<string, string[]>;
  onStepUpdate: (stepId: string, updates: Partial<TaskStep>) => void;
  onStepDelete: (stepId: string) => void;
  onStepEdit: (stepId: string | null) => void;
  onStepReorder: (fromIndex: number, toIndex: number) => void;
  onDragStart: (stepId: string) => void;
  onDragEnd: () => void;
}

// Features:
// - React DnD for drag-and-drop reordering
// - Empty state with helpful messaging
// - Validation error display
// - Smooth animations for reordering
```

### 2. StepCard Component (~180 lines)
```typescript
interface StepCardProps {
  step: TaskStep;
  isEditing: boolean;
  isDragging: boolean;
  validationErrors: string[];
  onEdit: () => void;
  onSave: (updates: Partial<TaskStep>) => void;
  onCancel: () => void;
  onDelete: () => void;
  onContextToggle: (enabled: boolean) => void;
}

// Features:
// - Collapsible card design
// - Inline editing mode
// - Context preview
// - Status indicators
// - Drag handle
```

### 3. StepEditor Component (~250 lines)
```typescript
interface StepEditorProps {
  step?: TaskStep;
  isOpen: boolean;
  onSave: (stepData: TaskStep) => void;
  onCancel: () => void;
  previousStepResult?: any;
}

// Features:
// - Modal dialog for detailed editing
// - Form validation
// - Context preview from previous step
// - Rich text editor for instructions
// - Step name validation
```

### 4. ContextToggle Component (~120 lines)
```typescript
interface ContextToggleProps {
  enabled: boolean;
  previousStepResult?: any;
  onToggle: (enabled: boolean) => void;
  disabled?: boolean;
}

// Features:
// - Toggle switch with preview
// - Context data visualization
// - Disabled state handling
// - Tooltip explanations
```

## Visual Design Specifications

### 1. Step Manager Header
```css
/* Gradient header matching TaskWizardModal style */
.step-manager-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.75rem 0.75rem 0 0;
}
```

### 2. Step Cards
```css
/* Card design with hover effects */
.step-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease-in-out;
}

.step-card:hover {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

.step-card.dragging {
  transform: rotate(5deg);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}
```

### 3. Context Toggle
```css
/* Context preview panel */
.context-preview {
  background: #f8fafc;
  border: 1px dashed #cbd5e1;
  border-radius: 0.375rem;
  padding: 0.75rem;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.75rem;
}
```

## Validation Rules

### 1. Step Validation
- **Step Name**: Required, 1-50 characters, unique within task
- **Instructions**: Required, 10-1000 characters
- **Step Order**: Auto-managed, must be sequential
- **Context Settings**: Valid only if previous step exists

### 2. Task-Level Validation
- **Minimum Steps**: At least 1 step required
- **Maximum Steps**: Limit to 20 steps for performance
- **Step Order**: Must be sequential without gaps
- **Context Flow**: Context dependencies must be valid

## Integration Points

### 1. TaskWizardModal Integration
- Replace current Step 4 (Instructions) with StepManager
- Update step indicator to show "Steps" instead of "Instructions"
- Maintain existing validation flow
- Preserve step navigation patterns

### 2. Database Integration
- Save steps via agent-tasks Edge Function
- Load existing steps for task editing
- Real-time validation against database constraints
- Optimistic updates with rollback on failure

### 3. Task Execution Integration
- Steps passed to task-executor in order
- Context data flows between steps
- Status updates reflected in UI
- Error handling per step

## Performance Considerations

### 1. Rendering Optimization
- Virtualized list for large step counts (>10 steps)
- Memoized step cards to prevent unnecessary re-renders
- Debounced validation to reduce computation
- Lazy loading of context previews

### 2. State Management
- Immutable state updates for predictable behavior
- Batched updates for drag-and-drop operations
- Optimistic UI updates with error rollback
- Local storage backup for unsaved changes

## Accessibility Features

### 1. Keyboard Navigation
- Tab order through steps and controls
- Enter/Space for editing steps
- Arrow keys for reordering (with modifier)
- Escape to cancel editing

### 2. Screen Reader Support
- Proper ARIA labels for all interactive elements
- Live regions for validation feedback
- Descriptive text for drag-and-drop operations
- Focus management during modal operations

### 3. Visual Accessibility
- High contrast mode support
- Focus indicators for all interactive elements
- Color-blind friendly status indicators
- Scalable text and UI elements

## File Size Compliance

### Component Size Breakdown
- **StepManager.tsx**: 280 lines (within 300 line limit)
- **StepList.tsx**: 200 lines (within 300 line limit)
- **StepCard.tsx**: 180 lines (within 300 line limit)
- **StepEditor.tsx**: 250 lines (within 300 line limit)
- **ContextToggle.tsx**: 120 lines (within 300 line limit)
- **useStepManager.ts**: 200 lines (within 300 line limit)

### Refactoring Requirements
- **TaskWizardModal.tsx**: Reduce from 534 to ~300 lines by extracting step logic
- Extract step-related state and handlers to custom hook
- Move step rendering logic to StepManager component
- Maintain existing wizard flow and styling

## References
- TaskWizardModal.tsx current implementation
- EnhancedChannelsModalRefactored.tsx component patterns
- Agentopia design system and theming
- React DnD library for drag-and-drop functionality
- Shadcn UI component library patterns
