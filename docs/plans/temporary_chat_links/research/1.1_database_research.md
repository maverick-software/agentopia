# Database Architecture Research for Temporary Chat Links

## Research Summary

This document analyzes the current Agentopia database architecture to understand how to implement temporary chat links functionality while maintaining compatibility with existing systems.

## Current Chat System Architecture

### Primary Tables

#### 1. `chat_messages_v2` (Current Active Schema)
- **Purpose**: Stores all chat messages with advanced JSON structure
- **Key Features**:
  - JSONB content structure with type validation
  - Support for multiple message types: 'text', 'structured', 'multimodal', 'tool_result'
  - Conversation and session tracking
  - Actor exclusivity (user XOR agent senders)
  - Rich metadata and context support

```sql
CREATE TABLE chat_messages_v2 (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  conversation_id UUID NOT NULL,
  session_id UUID NOT NULL,
  sender_user_id UUID REFERENCES auth.users(id),
  sender_agent_id UUID REFERENCES agents(id),
  role VARCHAR(20) NOT NULL CHECK (role IN ('system', 'user', 'assistant', 'tool')),
  content JSONB NOT NULL,
  metadata JSONB DEFAULT '{}',
  -- ... other fields
);
```

#### 2. `conversation_sessions` (Session Management)
- **Purpose**: Tracks conversation sessions with metrics and state
- **Key Features**:
  - Session state management ('active', 'paused', 'completed', 'abandoned')
  - Token usage and tool call tracking
  - Flexible actor support (user OR agent)
  - Interruption context handling

```sql
CREATE TABLE conversation_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  conversation_id UUID NOT NULL,
  user_id UUID REFERENCES auth.users(id),
  agent_id UUID REFERENCES agents(id),
  status VARCHAR(20) DEFAULT 'active',
  message_count INTEGER DEFAULT 0,
  -- ... metrics and state fields
);
```

## Compatibility Analysis

### Integration Points

1. **Message Storage**: Temporary chat messages can use existing `chat_messages_v2` table
2. **Session Management**: Can leverage `conversation_sessions` for tracking temporary sessions
3. **Agent References**: Existing `agents` table integration maintained
4. **Real-time**: Current real-time subscription system can be extended

### Required Modifications

#### New Tables Needed

1. **`temporary_chat_links`**: Store temporary link metadata
2. **`temporary_chat_sessions`**: Track anonymous sessions
3. **Optional: `temporary_chat_participants`**: Store anonymous participant info

## Proposed Database Schema Extensions

### 1. Temporary Chat Links Table
```sql
CREATE TABLE temporary_chat_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  agent_id UUID NOT NULL REFERENCES agents(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  
  -- Link identification
  link_token TEXT NOT NULL UNIQUE,
  short_code TEXT UNIQUE, -- Optional short URL code
  
  -- Configuration
  title TEXT NOT NULL,
  description TEXT,
  welcome_message TEXT,
  
  -- Access control
  expires_at TIMESTAMPTZ NOT NULL,
  max_sessions INTEGER DEFAULT 1,
  max_messages_per_session INTEGER DEFAULT 50,
  session_timeout_minutes INTEGER DEFAULT 30,
  
  -- Usage tracking
  session_count INTEGER DEFAULT 0,
  total_messages INTEGER DEFAULT 0,
  last_accessed_at TIMESTAMPTZ,
  
  -- Status
  is_active BOOLEAN DEFAULT TRUE,
  
  -- Security
  allowed_domains TEXT[], -- Optional domain restrictions
  rate_limit_per_minute INTEGER DEFAULT 10,
  
  -- Metadata
  link_metadata JSONB DEFAULT '{}',
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. Temporary Chat Sessions Table
```sql
CREATE TABLE temporary_chat_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  link_id UUID NOT NULL REFERENCES temporary_chat_links(id) ON DELETE CASCADE,
  conversation_session_id UUID NOT NULL REFERENCES conversation_sessions(id) ON DELETE CASCADE,
  
  -- Session identification
  session_token TEXT NOT NULL UNIQUE,
  
  -- Participant info (anonymous)
  participant_identifier TEXT, -- Optional: email, phone, or anonymous ID
  participant_name TEXT, -- Optional display name
  participant_metadata JSONB DEFAULT '{}',
  
  -- Session tracking
  started_at TIMESTAMPTZ DEFAULT NOW(),
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  ended_at TIMESTAMPTZ,
  
  -- Usage metrics
  message_count INTEGER DEFAULT 0,
  session_duration_seconds INTEGER,
  
  -- Status
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'ended', 'expired', 'terminated')),
  end_reason TEXT CHECK (end_reason IN ('completed', 'timeout', 'expired', 'terminated', 'error')),
  
  -- Security tracking
  ip_address INET,
  user_agent TEXT,
  
  -- Metadata
  session_metadata JSONB DEFAULT '{}'
);
```

### 3. Indexes and Performance Optimization
```sql
-- Temporary chat links indexes
CREATE INDEX idx_temp_links_agent ON temporary_chat_links(agent_id) WHERE is_active = TRUE;
CREATE INDEX idx_temp_links_user ON temporary_chat_links(user_id);
CREATE INDEX idx_temp_links_token ON temporary_chat_links(link_token);
CREATE INDEX idx_temp_links_expires ON temporary_chat_links(expires_at) WHERE is_active = TRUE;
CREATE INDEX idx_temp_links_active ON temporary_chat_links(is_active, expires_at);

-- Temporary chat sessions indexes
CREATE INDEX idx_temp_sessions_link ON temporary_chat_sessions(link_id);
CREATE INDEX idx_temp_sessions_token ON temporary_chat_sessions(session_token);
CREATE INDEX idx_temp_sessions_status ON temporary_chat_sessions(status, last_activity_at);
CREATE INDEX idx_temp_sessions_conversation ON temporary_chat_sessions(conversation_session_id);
```

## RLS (Row Level Security) Considerations

### Current RLS Patterns
- Users can only access their own agents and messages
- Service role has full access for system operations
- Agent-based access control for tool operations

### Required RLS Policies

#### For `temporary_chat_links`
```sql
-- Users can manage their own temporary links
CREATE POLICY "Users manage own temp links" ON temporary_chat_links
  FOR ALL USING (user_id = auth.uid());

-- Service role full access
CREATE POLICY "Service role full access temp links" ON temporary_chat_links
  FOR ALL USING (auth.role() = 'service_role');
```

#### For `temporary_chat_sessions`
```sql
-- No RLS needed - accessed via service role only for security
-- Public access handled through edge functions
```

## Integration with Existing Systems

### 1. Chat Messages Integration
- Use existing `chat_messages_v2` table
- Set `sender_user_id` to NULL for anonymous participants
- Use `metadata` field to store temporary session info
- Maintain conversation_id linkage

### 2. Conversation Sessions Integration
- Create standard `conversation_sessions` record
- Link to temporary session via foreign key
- Use existing session management logic

### 3. Agent Integration
- Standard agent_id references
- Existing agent permissions apply
- Tool access controlled by agent settings

## Security Considerations

### 1. Data Isolation
- Anonymous messages isolated from authenticated users
- No cross-contamination with regular user data
- Temporary session data cleanup

### 2. Rate Limiting
- Per-link rate limiting
- IP-based restrictions
- Session timeout enforcement

### 3. Audit Trail
- All temporary sessions logged
- IP and user agent tracking
- Message content retention policies

## Cleanup Strategy

### 1. Automatic Cleanup
```sql
-- Function to clean expired links and sessions
CREATE OR REPLACE FUNCTION cleanup_expired_temporary_chats()
RETURNS void AS $$
BEGIN
  -- Mark expired links as inactive
  UPDATE temporary_chat_links 
  SET is_active = FALSE 
  WHERE expires_at < NOW() AND is_active = TRUE;
  
  -- End expired sessions
  UPDATE temporary_chat_sessions 
  SET status = 'expired', ended_at = NOW()
  WHERE link_id IN (
    SELECT id FROM temporary_chat_links WHERE is_active = FALSE
  ) AND status = 'active';
END;
$$ LANGUAGE plpgsql;
```

### 2. Scheduled Cleanup
- pg_cron job for regular cleanup
- Configurable retention periods
- Archive vs delete options

## Migration Strategy

### Phase 1: Create New Tables
- Add temporary_chat_links table
- Add temporary_chat_sessions table
- Create indexes and RLS policies

### Phase 2: Integration Points
- Extend existing triggers if needed
- Add cleanup functions
- Set up scheduled jobs

### Phase 3: Testing and Validation
- Test with existing chat system
- Validate RLS policies
- Performance testing

## Risks and Mitigation

### 1. Performance Impact
- **Risk**: Additional tables and queries
- **Mitigation**: Proper indexing, cleanup jobs, query optimization

### 2. Security Vulnerabilities
- **Risk**: Anonymous access, abuse potential
- **Mitigation**: Rate limiting, content filtering, audit logging

### 3. Data Privacy
- **Risk**: Temporary data retention
- **Mitigation**: Automatic cleanup, configurable retention, GDPR compliance

## Next Steps

1. **Review existing migration patterns** in `supabase/migrations/`
2. **Test schema compatibility** with current system
3. **Design edge function integration** points
4. **Plan RLS policy implementation**
5. **Create migration files** following project conventions

## File Dependencies for Implementation

- `supabase/migrations/YYYYMMDD_create_temporary_chat_links.sql`
- `supabase/migrations/YYYYMMDD_create_temporary_chat_sessions.sql`
- `supabase/migrations/YYYYMMDD_add_temporary_chat_cleanup.sql`

## Backup Requirements

Before implementing:
- Backup current schema: `docs/plans/temporary_chat_links/backups/current_schema.sql`
- Backup related migration files
- Test on shadow database first
