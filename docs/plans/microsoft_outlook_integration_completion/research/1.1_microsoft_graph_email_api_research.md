# Microsoft Graph API Email Operations Research

**Date:** September 10, 2025  
**Research Item:** WBS 1.1 - Microsoft Graph API Research - Email Operations  
**Purpose:** Research Microsoft Graph API endpoints and patterns for email operations  

## Microsoft Graph API Email Endpoints

### Base URL and Authentication
- **Base URL:** `https://graph.microsoft.com/v1.0/`
- **Authentication:** Bearer token from OAuth 2.0 flow
- **Required Headers:**
  - `Authorization: Bearer {access_token}`
  - `Content-Type: application/json`

### Key Email Endpoints

#### 1. Send Email
- **Endpoint:** `POST /me/sendMail`
- **Purpose:** Send an email message
- **Payload Structure:**
```json
{
  "message": {
    "subject": "Email subject",
    "body": {
      "contentType": "Text", // or "HTML"
      "content": "Email body content"
    },
    "toRecipients": [
      {
        "emailAddress": {
          "address": "recipient@example.com",
          "name": "Recipient Name"
        }
      }
    ],
    "ccRecipients": [
      {
        "emailAddress": {
          "address": "cc@example.com",
          "name": "CC Name"
        }
      }
    ],
    "bccRecipients": [
      {
        "emailAddress": {
          "address": "bcc@example.com",
          "name": "BCC Name"
        }
      }
    ],
    "attachments": [
      {
        "@odata.type": "#microsoft.graph.fileAttachment",
        "name": "attachment.pdf",
        "contentBytes": "base64encodedcontent"
      }
    ]
  },
  "saveToSentItems": true
}
```

#### 2. List Messages
- **Endpoint:** `GET /me/messages`
- **Purpose:** Get user's messages
- **Query Parameters:**
  - `$top`: Number of messages to return (default: 10, max: 999)
  - `$skip`: Number of messages to skip
  - `$filter`: Filter criteria
  - `$select`: Specific properties to return
  - `$orderby`: Sort order
- **Example:** `GET /me/messages?$top=25&$select=subject,from,receivedDateTime,isRead`

#### 3. Get Specific Message
- **Endpoint:** `GET /me/messages/{message-id}`
- **Purpose:** Get details of a specific message
- **Example:** `GET /me/messages/AAMkAGVmMDEzMTM4LTZmYWUtNDdkNC1hMDZiLTU1OGY5OTZhYmY4OABGAAAAAAAiQ8W967B7TKBjgx9rVEURBwAiIsqMbYjsT5e-T7KzowPTAAAAAAEMAAAiIsqMbYjsT5e-T7KzowPTAAAYNUm3AAA%3D`

#### 4. Search Messages
- **Endpoint:** `GET /me/messages?$search="search query"`
- **Purpose:** Search messages by content, subject, sender, etc.
- **Example:** `GET /me/messages?$search="quarterly report"`

#### 5. Mark Message as Read/Unread
- **Endpoint:** `PATCH /me/messages/{message-id}`
- **Purpose:** Update message properties
- **Payload:**
```json
{
  "isRead": true
}
```

#### 6. Delete Message
- **Endpoint:** `DELETE /me/messages/{message-id}`
- **Purpose:** Delete a message

### Error Handling Patterns

#### Common HTTP Status Codes
- **200 OK:** Successful request
- **201 Created:** Resource created successfully
- **204 No Content:** Successful request with no response body
- **400 Bad Request:** Invalid request parameters
- **401 Unauthorized:** Invalid or expired token
- **403 Forbidden:** Insufficient permissions
- **404 Not Found:** Resource not found
- **429 Too Many Requests:** Rate limit exceeded
- **500 Internal Server Error:** Microsoft Graph service error

#### Error Response Format
```json
{
  "error": {
    "code": "ErrorCode",
    "message": "Error message description",
    "innerError": {
      "date": "2025-09-10T10:30:00",
      "request-id": "request-id-guid",
      "client-request-id": "client-request-id-guid"
    }
  }
}
```

### Rate Limiting
- **Throttling Limits:** 10,000 requests per 10 minutes per application per tenant
- **Headers to Monitor:**
  - `Retry-After`: Number of seconds to wait before retrying
  - `X-RateLimit-Remaining`: Remaining requests in current window
  - `X-RateLimit-Reset`: Time when rate limit resets

### Required OAuth Scopes for Email Operations

#### Minimum Scopes
- `Mail.Send` - Send emails on behalf of user
- `Mail.Read` - Read user's emails
- `Mail.ReadWrite` - Read and modify user's emails
- `User.Read` - Read user profile information

#### Scope Descriptions
- **Mail.Send:** Allows sending emails but not reading existing emails
- **Mail.Read:** Read-only access to user's mailbox
- **Mail.ReadWrite:** Full access to read, write, and delete emails
- **Mail.ReadBasic:** Read basic email properties (subject, sender, date)

## Implementation Considerations

### Token Management
- Access tokens expire (typically 1 hour)
- Must implement refresh token logic
- Store tokens securely in Supabase Vault
- Handle token refresh transparently

### Error Handling Strategy
1. **Retry Logic:** Implement exponential backoff for transient errors (429, 503, 504)
2. **Token Refresh:** Automatically refresh expired tokens (401 errors)
3. **User-Friendly Messages:** Convert technical errors to actionable messages
4. **LLM-Friendly Errors:** Format errors as questions for retry mechanism

### Performance Optimization
1. **Batch Requests:** Use `$batch` endpoint for multiple operations
2. **Select Specific Fields:** Use `$select` to reduce payload size
3. **Pagination:** Implement proper pagination for large result sets
4. **Caching:** Cache frequently accessed data where appropriate

### Security Best Practices
1. **Validate Input:** Sanitize all user input before API calls
2. **Scope Validation:** Verify user has required scopes before operations
3. **Rate Limiting:** Implement client-side rate limiting
4. **Logging:** Log all API calls for audit purposes

## Integration with Existing Patterns

### Comparison with Gmail API
**Similarities:**
- REST API with JSON payloads
- OAuth 2.0 authentication
- Similar email operations (send, read, search)

**Differences:**
- Different endpoint structure (`/me/sendMail` vs `/gmail/v1/users/me/messages/send`)
- Different payload format (Graph uses nested objects)
- Unified API (Graph covers email, calendar, contacts)
- Different error response format

### Alignment with Agentopia Patterns
- Use existing Supabase Vault for token storage
- Follow Universal Tool Executor routing patterns
- Implement LLM-friendly error messages
- Use consistent tool naming convention (`outlook_send_email`)

## Next Steps for Implementation
1. Create Microsoft Graph API client utility
2. Implement individual email operation functions
3. Add proper error handling and retry logic
4. Test with actual Microsoft accounts
5. Integrate with Universal Tool Executor
