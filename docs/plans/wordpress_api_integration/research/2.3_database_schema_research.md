# Database Schema Research for WordPress Integration

## Research Overview
This document analyzes the database schema requirements for WordPress REST API integration, examining existing patterns in Agentopia and WordPress authentication methods.

## Current Agentopia Database Architecture

### Service Providers Table Structure
Based on analysis of `supabase/migrations/20250107000000_create_oauth_providers.sql`:

```sql
CREATE TABLE IF NOT EXISTS service_providers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT UNIQUE NOT NULL,
    display_name TEXT NOT NULL,
    authorization_url TEXT NOT NULL,
    token_url TEXT NOT NULL,
    user_info_url TEXT,
    scopes JSONB DEFAULT '[]'::jsonb,
    configuration JSONB DEFAULT '{}'::jsonb,
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now()
);
```

### User Integration Credentials Table
From security documentation analysis:

```sql
CREATE TABLE user_integration_credentials (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  service_provider_id uuid NOT NULL,  -- References service_providers table
  credential_type 'oauth' | 'api_key' NOT NULL,
  
  -- SECURE STORAGE: Only vault UUIDs stored
  vault_access_token_id text,    -- Vault UUID for token/key
  vault_refresh_token_id text,   -- Vault UUID for refresh token (OAuth only)
  encrypted_access_token text,   -- DEPRECATED: Always NULL in new system
  encrypted_refresh_token text,  -- DEPRECATED: Always NULL in new system
  
  -- Metadata and status
  connection_name text NOT NULL,
  connection_status text DEFAULT 'active',
  token_expires_at timestamptz,
  created_at timestamptz DEFAULT now()
);
```

## WordPress Authentication Methods Analysis

### 1. Application Passwords (Recommended)
- **Introduced**: WordPress 5.6+
- **Security**: High - no password exposure
- **Implementation**: Username + Application Password
- **Credential Type**: `api_key` in our system
- **Storage Requirements**:
  - Site URL
  - Username
  - Application Password (vault-encrypted)

### 2. OAuth 2.0 (Future Enhancement)
- **Security**: Highest - token-based with refresh capability
- **Implementation**: Standard OAuth flow
- **Credential Type**: `oauth` in our system
- **Storage Requirements**:
  - Site URL
  - Client ID/Secret
  - Access/Refresh tokens (vault-encrypted)

### 3. Basic Authentication (Legacy - Not Recommended)
- **Security**: Low - password exposure risk
- **Implementation**: Username + Password
- **Status**: Deprecated in WordPress, not implementing

## WordPress-Specific Schema Requirements

### Service Provider Configuration
WordPress sites are unique because each site is a separate "provider" with the same API structure but different endpoints.

**Approach 1: Single WordPress Provider (Recommended)**
```sql
-- Single service provider entry for all WordPress sites
INSERT INTO service_providers (
  name: 'wordpress',
  display_name: 'WordPress',
  authorization_url: '', -- Not used for Application Passwords
  token_url: '',         -- Not used for Application Passwords
  user_info_url: '{site_url}/wp-json/wp/v2/users/me',
  scopes: '["read", "write", "delete"]',
  configuration: '{
    "api_base_path": "/wp-json/wp/v2",
    "supports_application_passwords": true,
    "supports_oauth": false,
    "required_wp_version": "5.6"
  }'
);
```

**Connection Metadata Structure**
```json
{
  "site_url": "https://example.com",
  "wp_version": "6.4.2",
  "api_base_url": "https://example.com/wp-json/wp/v2",
  "username": "admin",
  "capabilities": ["read", "write", "delete", "manage_options"],
  "site_info": {
    "name": "Example Site",
    "description": "Just another WordPress site",
    "timezone": "America/New_York"
  },
  "connection_method": "application_password",
  "last_verified": "2025-09-14T10:30:00Z"
}
```

## Integration with Existing Architecture

### 1. Leverage Existing Tables
- Use existing `service_providers` table
- Use existing `user_integration_credentials` table
- Use existing `agent_integration_permissions` table

### 2. WordPress-Specific Considerations
- **Site URL Validation**: Ensure WordPress site accessibility
- **API Availability**: Verify REST API is enabled
- **Version Compatibility**: Check WordPress version >= 5.6 for Application Passwords
- **Capability Detection**: Discover available endpoints and user capabilities

### 3. Vault Storage Requirements
Following Agentopia's security protocol:
- **Application Password**: Store in vault as `vault_access_token_id`
- **Site URL**: Store in `connection_metadata` (not sensitive)
- **Username**: Store in `external_username` field

## Database Migration Requirements

### 1. Add WordPress Service Provider
```sql
INSERT INTO service_providers (
  name,
  display_name,
  authorization_url,
  token_url,
  user_info_url,
  scopes,
  configuration,
  is_enabled
) VALUES (
  'wordpress',
  'WordPress',
  '', -- Not applicable for Application Passwords
  '', -- Not applicable for Application Passwords
  '', -- Dynamic based on site URL
  '["read", "write", "delete", "manage_options"]',
  '{
    "provider_type": "api_key",
    "api_base_path": "/wp-json/wp/v2",
    "supports_application_passwords": true,
    "supports_oauth": false,
    "required_wp_version": "5.6",
    "authentication_method": "application_password"
  }',
  true
);
```

### 2. No Additional Tables Required
The existing schema supports WordPress integration without modifications.

## Security Considerations

### 1. Credential Storage
- **Application Passwords**: Stored in Supabase Vault
- **Site URLs**: Validated for HTTPS in production
- **User Capabilities**: Cached in connection metadata

### 2. Connection Validation
- Verify WordPress site accessibility
- Test API endpoint availability
- Validate user permissions
- Check SSL certificate validity

### 3. Rate Limiting
- Respect WordPress site rate limits
- Implement exponential backoff
- Cache frequently accessed data

## Implementation Notes

### 1. Connection Establishment Flow
1. User provides WordPress site URL and credentials
2. Validate site accessibility and API availability
3. Test authentication with provided credentials
4. Discover user capabilities and site information
5. Store credentials securely in vault
6. Create connection record with metadata

### 2. Error Handling
- Invalid site URL
- API not available/disabled
- Authentication failure
- Insufficient permissions
- Network connectivity issues

### 3. Future Enhancements
- OAuth 2.0 support for enhanced security
- WordPress.com hosted sites support
- Multisite network support
- Custom endpoint discovery

## Alignment with Existing Codebase

### 1. Follows Established Patterns
- Uses existing service provider architecture
- Leverages Supabase Vault for security
- Implements standard connection flow
- Maintains RLS policies

### 2. Integration Points
- `src/integrations/_shared/services/VaultService.ts`
- `src/integrations/_shared/hooks/useConnections.ts`
- `supabase/functions/` for API proxy

### 3. Consistency with Other Integrations
- Similar to Serper API (API key based)
- Follows Gmail pattern for setup modal
- Uses standard permission management

## Conclusion

The WordPress integration can be implemented using the existing database schema without modifications. The approach leverages:

1. **Existing Tables**: `service_providers`, `user_integration_credentials`
2. **Security**: Supabase Vault for credential storage
3. **Flexibility**: JSON metadata for WordPress-specific configuration
4. **Scalability**: Support for multiple WordPress sites per user

This design maintains consistency with Agentopia's architecture while providing comprehensive WordPress REST API integration capabilities.
