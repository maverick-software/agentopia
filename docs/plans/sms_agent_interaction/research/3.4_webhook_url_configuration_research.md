# Webhook URL Configuration Research for ClickSend SMS

## Current Integration Patterns Analysis

### Existing Webhook URL Display Patterns
Based on analysis of the Stripe configuration panel and ClickSend setup modal, Agentopia uses these patterns:

**Stripe Webhook Configuration:**
```tsx
<Input
  id="webhook_url"
  type="url"
  value={`${window.location.origin}/functions/v1/stripe-webhook`}
  readOnly
  className="bg-gray-50 dark:bg-gray-800"
/>
<p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
  Configure this URL in your Stripe Dashboard → Developers → Webhooks
</p>
```

**ClickSend Setup Instructions:**
```tsx
<div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
  <h3 className="font-semibold text-blue-900 mb-2">Setup Instructions</h3>
  <ol className="text-sm text-blue-800 space-y-1">
    <li>1. Sign up for ClickSend account at <span className="font-mono">clicksend.com</span></li>
    <li>2. Navigate to API Credentials in your dashboard</li>
    <li>3. Copy your Username and API Key</li>
    <li>4. Enter credentials below</li>
  </ol>
</div>
```

## ClickSend Webhook URL Configuration Strategy

### URL Generation Pattern
Following the existing pattern, the webhook URL should be:
```
${window.location.origin}/functions/v1/clicksend-inbound-webhook
```

**Examples:**
- **Production**: `https://myproject.supabase.co/functions/v1/clicksend-inbound-webhook`
- **Local Development**: `http://localhost:54321/functions/v1/clicksend-inbound-webhook`
- **Custom Domain**: `https://api.mycompany.com/functions/v1/clicksend-inbound-webhook`

### Implementation Locations

#### 1. SMS Interaction Settings Modal
Add webhook configuration section to the SMS interaction settings modal:

```tsx
// In SmsInteractionSettings.tsx
<div className="space-y-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
  <h4 className="font-semibold text-amber-900 flex items-center gap-2">
    <Globe className="w-4 h-4" />
    ClickSend Webhook Configuration
  </h4>
  
  <div className="space-y-3">
    <div>
      <Label htmlFor="webhook-url">Webhook URL</Label>
      <div className="flex items-center gap-2">
        <Input
          id="webhook-url"
          type="url"
          value={`${window.location.origin}/functions/v1/clicksend-inbound-webhook`}
          readOnly
          className="bg-white font-mono text-sm"
        />
        <Button
          variant="outline"
          size="sm"
          onClick={() => copyToClipboard(`${window.location.origin}/functions/v1/clicksend-inbound-webhook`)}
        >
          <Copy className="w-4 h-4" />
        </Button>
      </div>
    </div>
    
    <div className="text-sm text-amber-800">
      <p className="font-medium mb-2">Configuration Steps:</p>
      <ol className="space-y-1 ml-4">
        <li>1. Login to your <a href="https://dashboard.clicksend.com" target="_blank" className="underline">ClickSend Dashboard</a></li>
        <li>2. Navigate to <strong>Profile → Messaging Settings → SMS & MMS</strong></li>
        <li>3. Click <strong>Inbound Rules</strong></li>
        <li>4. Click <strong>Add New Rule</strong></li>
        <li>5. Select <strong>URL</strong> as the action</li>
        <li>6. Paste the webhook URL above</li>
        <li>7. Click <strong>Save</strong></li>
      </ol>
    </div>
    
    <div className="flex items-start gap-2 p-3 bg-blue-50 rounded border border-blue-200">
      <AlertCircle className="w-4 h-4 text-blue-600 mt-0.5 shrink-0" />
      <div className="text-sm text-blue-800">
        <p className="font-medium">Important:</p>
        <p>SMS interaction will only work after configuring this webhook URL in your ClickSend account.</p>
      </div>
    </div>
  </div>
</div>
```

#### 2. Enhanced ClickSend Setup Modal
Extend the existing ClickSend setup modal to include webhook configuration:

```tsx
// Enhanced ClickSendSetupModal.tsx
{/* Add after existing setup instructions */}
{testResult?.success && (
  <div className="p-4 bg-green-50 rounded-lg border border-green-200">
    <h3 className="font-semibold text-green-900 mb-3 flex items-center gap-2">
      <CheckCircle className="w-4 h-4" />
      Connection Successful - Enable SMS Interaction
    </h3>
    
    <div className="space-y-3">
      <p className="text-sm text-green-800">
        To receive SMS messages from users, configure the webhook URL in your ClickSend dashboard:
      </p>
      
      <div>
        <Label className="text-sm font-medium text-green-900">Webhook URL</Label>
        <div className="flex items-center gap-2 mt-1">
          <Input
            type="url"
            value={`${window.location.origin}/functions/v1/clicksend-inbound-webhook`}
            readOnly
            className="bg-white font-mono text-xs"
          />
          <Button
            variant="outline"
            size="sm"
            onClick={() => copyToClipboard(`${window.location.origin}/functions/v1/clicksend-inbound-webhook`)}
          >
            <Copy className="w-3 h-3" />
          </Button>
        </div>
      </div>
      
      <details className="text-sm">
        <summary className="cursor-pointer font-medium text-green-900 hover:text-green-700">
          View Configuration Steps
        </summary>
        <ol className="mt-2 space-y-1 ml-4 text-green-800">
          <li>1. Open <a href="https://dashboard.clicksend.com" target="_blank" className="underline">ClickSend Dashboard</a></li>
          <li>2. Go to Profile → Messaging Settings → SMS & MMS → Inbound Rules</li>
          <li>3. Add New Rule → Select "URL" → Paste webhook URL → Save</li>
        </ol>
      </details>
    </div>
  </div>
)}
```

#### 3. Agent Settings Quick Setup
Add webhook configuration to the ChannelsTab SMS section:

```tsx
// In ChannelsTab.tsx - SMS channel card enhancement
{channel.id === 'sms_enabled' && channel.enabled && (
  <div className="mt-4 pt-4 border-t">
    <div className="flex items-center justify-between mb-2">
      <h5 className="font-medium text-sm">SMS Interaction</h5>
      <Badge variant={smsSettings.sms_interaction_enabled ? "default" : "secondary"}>
        {smsSettings.sms_interaction_enabled ? "Enabled" : "Disabled"}
      </Badge>
    </div>
    
    {!smsSettings.sms_interaction_enabled && (
      <div className="text-xs text-muted-foreground mb-2">
        Configure ClickSend webhook to enable two-way SMS communication
      </div>
    )}
    
    <div className="flex items-center gap-2">
      <Button 
        variant="outline" 
        size="sm"
        onClick={() => setShowWebhookConfig(true)}
      >
        <Globe className="w-4 h-4 mr-1" />
        Webhook Setup
      </Button>
      
      <Button 
        variant="outline" 
        size="sm"
        onClick={() => setShowSmsSettings(true)}
      >
        <Settings className="w-4 h-4 mr-1" />
        Settings
      </Button>
    </div>
  </div>
)}
```

### Webhook Configuration Modal Component

Create a dedicated modal for webhook configuration:

```tsx
// New component: WebhookConfigurationModal.tsx
interface WebhookConfigModalProps {
  isOpen: boolean;
  onClose: () => void;
  provider: 'clicksend' | 'stripe' | 'other';
  webhookUrl: string;
  configurationSteps: ConfigurationStep[];
}

interface ConfigurationStep {
  step: number;
  description: string;
  link?: string;
  highlight?: string;
}

export function WebhookConfigurationModal({
  isOpen,
  onClose,
  provider,
  webhookUrl,
  configurationSteps
}: WebhookConfigModalProps) {
  const [copied, setCopied] = useState(false);
  
  const copyToClipboard = async (text: string) => {
    try {
      await navigator.clipboard.writeText(text);
      setCopied(true);
      toast.success('Webhook URL copied to clipboard');
      setTimeout(() => setCopied(false), 2000);
    } catch (error) {
      toast.error('Failed to copy URL');
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="sm:max-w-[600px]">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Globe className="w-5 h-5" />
            {provider.charAt(0).toUpperCase() + provider.slice(1)} Webhook Configuration
          </DialogTitle>
          <DialogDescription>
            Configure your {provider} account to send webhooks to Agentopia
          </DialogDescription>
        </DialogHeader>
        
        <div className="space-y-6">
          {/* Webhook URL Section */}
          <div className="space-y-2">
            <Label htmlFor="webhook-url">Webhook URL</Label>
            <div className="flex items-center gap-2">
              <Input
                id="webhook-url"
                type="url"
                value={webhookUrl}
                readOnly
                className="bg-muted font-mono text-sm"
              />
              <Button
                variant="outline"
                size="sm"
                onClick={() => copyToClipboard(webhookUrl)}
                className={copied ? "text-green-600" : ""}
              >
                {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
              </Button>
            </div>
          </div>
          
          {/* Configuration Steps */}
          <div className="space-y-3">
            <h4 className="font-medium">Configuration Steps</h4>
            <div className="space-y-2">
              {configurationSteps.map((step) => (
                <div key={step.step} className="flex items-start gap-3 p-3 border rounded-lg">
                  <div className="w-6 h-6 bg-primary text-primary-foreground rounded-full flex items-center justify-center text-sm font-medium shrink-0">
                    {step.step}
                  </div>
                  <div className="flex-1">
                    <p className="text-sm" dangerouslySetInnerHTML={{ __html: step.description }} />
                    {step.link && (
                      <a 
                        href={step.link} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-xs text-primary underline mt-1 inline-block"
                      >
                        Open {provider} Dashboard →
                      </a>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
          
          {/* Important Notes */}
          <div className="p-4 bg-amber-50 rounded-lg border border-amber-200">
            <div className="flex items-start gap-2">
              <AlertTriangle className="w-4 h-4 text-amber-600 mt-0.5 shrink-0" />
              <div className="text-sm text-amber-800">
                <p className="font-medium">Important Notes:</p>
                <ul className="mt-1 space-y-1 ml-4 list-disc">
                  <li>The webhook URL must be configured for SMS interaction to work</li>
                  <li>Changes may take a few minutes to take effect</li>
                  <li>Ensure your {provider} account has sufficient credits</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <div className="flex justify-end">
          <Button onClick={onClose}>
            Done
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### Usage Examples

#### ClickSend Configuration Steps
```tsx
const clicksendSteps: ConfigurationStep[] = [
  {
    step: 1,
    description: 'Login to your <strong>ClickSend Dashboard</strong>',
    link: 'https://dashboard.clicksend.com'
  },
  {
    step: 2,
    description: 'Navigate to <strong>Profile → Messaging Settings → SMS & MMS</strong>'
  },
  {
    step: 3,
    description: 'Click <strong>Inbound Rules</strong>'
  },
  {
    step: 4,
    description: 'Click <strong>Add New Rule</strong>'
  },
  {
    step: 5,
    description: 'Select <strong>URL</strong> as the action type'
  },
  {
    step: 6,
    description: 'Paste the webhook URL from above into the URL field'
  },
  {
    step: 7,
    description: 'Click <strong>Save</strong> to activate the webhook'
  }
];

// Usage
<WebhookConfigurationModal
  isOpen={showWebhookConfig}
  onClose={() => setShowWebhookConfig(false)}
  provider="clicksend"
  webhookUrl={`${window.location.origin}/functions/v1/clicksend-inbound-webhook`}
  configurationSteps={clicksendSteps}
/>
```

## Environment-Specific Considerations

### Development Environment
For local development with ngrok:
```tsx
const getWebhookUrl = () => {
  if (process.env.NODE_ENV === 'development' && process.env.NGROK_URL) {
    return `${process.env.NGROK_URL}/functions/v1/clicksend-inbound-webhook`;
  }
  return `${window.location.origin}/functions/v1/clicksend-inbound-webhook`;
};
```

### Production Environment
For production, the URL will automatically resolve to the correct Supabase project URL:
```
https://[project-ref].supabase.co/functions/v1/clicksend-inbound-webhook
```

## User Experience Flow

### 1. Initial Setup
1. User sets up ClickSend credentials in integrations page
2. Success message includes webhook configuration prompt
3. User clicks "Configure Webhook" button
4. Webhook configuration modal opens with URL and steps

### 2. SMS Interaction Enable
1. User goes to Agent Settings → Channels → SMS
2. Sees "SMS Interaction" section with webhook setup button
3. Clicks webhook setup to see configuration modal
4. Follows steps to configure ClickSend webhook
5. Enables SMS interaction toggle

### 3. Verification
1. System could provide a test endpoint to verify webhook
2. User sends test SMS to verify configuration
3. Success confirmation in UI

## Security Considerations

### URL Validation
- Always use HTTPS in production
- Validate the generated URL format
- Provide clear security warnings for HTTP (development only)

### Configuration Verification
- Provide webhook testing functionality
- Monitor webhook health and connectivity
- Alert users if webhook stops working

This research provides a comprehensive approach to guiding users through ClickSend webhook configuration, following established patterns while ensuring clear, actionable instructions.
