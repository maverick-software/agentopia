# UI & Feature Flags Design

## Pages & Components

### GraphSettingsPage (Account level)
- Purpose: Configure knowledge graph provider, connection, and retrieval/matching/fusion settings
- Route: `/graph-settings` (protected)
- Sections:
  - Status + connection (provider, connection name, state)
  - Retrieval (confidence_threshold, hop_depth, max_results)
  - Fusion weights (vector_weight, graph_weight, recency_weight)
  - Advanced: matching thresholds, auto-extraction settings
- Dependencies: `useAuth`, Supabase client, feature flag checks, shadcn/ui components

### Agent Graph Overrides
- Embedded in agent edit UI
- Toggles: enable graph, override confidence, hop depth, fusion weight
- Warnings if no account graph configured

### ProcessModal Enhancements
- New Graph Operations panel
- Shows: concepts extracted, nodes/edges counts, hop depth, fusion weight, time, quality score

## Feature Flags
- `ENABLE_ACCOUNT_GRAPH` (bool): master toggle
- `ENABLE_GRAPH_FUSION` (bool): enable fusion pipeline
- `ENABLE_AUTO_EXTRACTION` (bool): background extraction of entities/relations
- `ENABLE_GRAPH_UI` (bool): expose `/graph-settings`
- Values read in edge function via `Deno.env.get`, in UI via build-time config or DB flags

## Acceptance Criteria
- If `ENABLE_GRAPH_UI=true`, sidebar shows Knowledge Graph; page loads and persists settings
- If no account graph, Agent overrides panel shows warning and disables controls
- ProcessModal shows Graph Operations when fusion ran; hides otherwise
- All settings persist to `account_graphs.settings` JSONB

## Data Model Mappings
- account_graphs.settings:
```json
{
  "retrieval": {"confidence_threshold": 0.5, "hop_depth": 2, "max_results": 50},
  "fusion": {"vector_weight": 0.6, "graph_weight": 0.3, "recency_weight": 0.1},
  "matching": {"merge_threshold": 0.85, "create_threshold": 0.3, "review_threshold": 0.6},
  "extraction": {"enable_auto_extraction": true, "confidence_threshold": 0.7, "batch_size": 100, "processing_delay_ms": 5000}
}
```

## Navigation & Routing
- Add `/graph-settings` route behind `ProtectedRoute`
- Sidebar link gated by `ENABLE_GRAPH_UI`

## Telemetry & Logs
- UI: log save events, validation errors
- Edge: record fusion metrics, neighborhood query timings

## Risks
- UI complexity creep: keep sections minimal by default; collapse advanced
- Flag drift: centralize accessors for flags to avoid inconsistencies


