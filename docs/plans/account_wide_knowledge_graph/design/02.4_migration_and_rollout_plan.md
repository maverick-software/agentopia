# Migration & Rollout Plan

## Objectives
- Introduce account-wide graph with zero downtime
- Safely migrate existing GetZep datastores
- Backfill historical content gradually
- Roll out features in phases with monitoring and rollback

## Sequence
1) Create tables, indexes, and RLS (safe, additive)
2) Insert/verify provider records (if needed)
3) Migrate GetZep datastores → account_graphs
4) Enable background ingestion worker (guarded by flags)
5) Enable UI and agent overrides for allowlisted users
6) Turn on graph-vector fusion for beta cohort
7) Full rollout after SLOs are met

## Dependencies
- Supabase service role key available to ingestion worker
- Vault RPC for decrypting API keys
- Monitoring dashboards for latency/errors/queue

## Backfill
- Edge function `graph-backfill` processes messages/documents in batches
- Priority low; rate limited; resumable via offset
- Queue payloads into `graph_ingestion_queue`

## Rollout Phases
- internal_testing → alpha_users → beta_rollout → full_rollout
- Gated by feature flags + allowlist + percentage-based eligibility

## Monitoring
- Metrics: error_rate, avg_response_time_ms, graph_ops_count, queue_size, cost_per_user
- Alerting on thresholds; triggers for rollback

## Rollback
- Disable flags; pause queues; optionally archive & truncate graph tables
- Remove account_graph_id references from datastores

## Risks & Mitigations
- Data inconsistency: use idempotent external_ids; reconciliation jobs
- Performance spikes: rate limit backfill; cache results; batch operations
- Cost overrun: monitor per-user cost; throttle extraction

## Success Criteria
- >95% migration success; <2% error rate; <10% latency increase; <$0.25/user/month cost
