# GraphService API Spec (GetZep-backed)

## Overview
- Purpose: Provide a stable, typed client that wraps GetZep graph operations (nodes, edges, queries)
- Auth: API key resolved via `account_graphs.connection_id` → `user_oauth_connections.vault_access_token_id` → `vault_decrypt`
- Timeouts: 30s default; Retries: exponential backoff on 429/5xx (max 3)
- Idempotency: Use `external_id` for nodes/edges to support safe retries

## Interfaces
```typescript
export interface GraphNodeInput {
  id: string;              // external_id (stable hash)
  type: string;            // entity type
  label: string;
  aliases?: string[];
  properties?: Record<string, any>;
  confidence?: number;     // 0..1
}

export interface GraphEdgeInput {
  id: string;              // external_id
  source_id: string;       // external_id of source node
  target_id: string;       // external_id of target node
  type: string;            // relationship type
  properties?: Record<string, any>;
  confidence?: number;     // 0..1
}

export interface NeighborhoodQuery {
  node_ids?: string[];     // external_ids
  concepts?: string[];     // optional concept seeds
  hop_depth?: number;      // default 2
  limit?: number;          // default 50
  confidence_threshold?: number; // default 0.5
  edge_types?: string[];
}

export interface GraphService {
  upsertNodes(nodes: GraphNodeInput[]): Promise<{ created: number; updated: number }>;
  upsertEdges(edges: GraphEdgeInput[]): Promise<{ created: number; updated: number }>;
  queryNeighborhood(q: NeighborhoodQuery): Promise<{ nodes: any[]; edges: any[] }>;
  getNode(id: string): Promise<any | null>;      // by external_id
  deleteNode(id: string): Promise<boolean>;      // by external_id
  health(): Promise<{ status: 'healthy' | 'error'; details?: string }>;
}
```

## Errors & Retries
- 400: ValidationError (do not retry)
- 401/403: AuthError (do not retry; re-authenticate)
- 404: NotFound (do not retry)
- 409: Conflict (safe to retry with idempotency key)
- 429: RateLimited (retry with backoff: 1s, 2s, 4s)
- 5xx: ServerError (retry with backoff; max 3)

## Concurrency & Batching
- Nodes: batch size 100-500 per call depending on payload size
- Edges: batch size 1000-5000
- Client enforces max in-flight requests (concurrency limit e.g., 3)

## Telemetry
- Emit: request_id, endpoint, latency_ms, status, retry_count
- Capture: failure reasons, throttling indicators

## Security
- API key stored in Vault; never logged
- PII in properties should be minimized; adhere to privacy flags

## Integration
- Factory: `GraphServiceFactory.createGetZepService(accountGraphId, supabase)` resolves API key and returns an instance
- Used by: ingestion workers (upserts) and retrieval pipeline (neighborhood queries)


