# Database Schema Research - Task 1.1

**Date:** August 24, 2025  
**Task:** 1.1 Database Schema Research  
**Objective:** Research existing database patterns and design SMTP schema

## Existing Database Patterns Analysis

### 1. SendGrid Integration Pattern (Email Service)

**Primary Table: `sendgrid_configurations`**
```sql
CREATE TABLE sendgrid_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id),
    api_key_vault_id UUID NOT NULL,  -- Encrypted API key
    from_email TEXT NOT NULL,
    from_name TEXT,
    reply_to_email TEXT,
    webhook_url TEXT,
    webhook_secret_vault_id UUID,
    is_active BOOLEAN DEFAULT true,
    max_emails_per_day INTEGER DEFAULT 1000,
    max_recipients_per_email INTEGER DEFAULT 100,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Permission Table: `agent_sendgrid_permissions`**
```sql
CREATE TABLE agent_sendgrid_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL,
    sendgrid_config_id UUID NOT NULL,
    can_send_email BOOLEAN DEFAULT true,
    can_use_templates BOOLEAN DEFAULT false,
    can_send_bulk BOOLEAN DEFAULT false,
    can_manage_templates BOOLEAN DEFAULT false,
    can_view_analytics BOOLEAN DEFAULT false,
    can_receive_emails BOOLEAN DEFAULT false,
    daily_send_limit INTEGER DEFAULT 100,
    recipients_per_email_limit INTEGER DEFAULT 10,
    granted_by UUID NOT NULL,
    granted_at TIMESTAMPTZ DEFAULT NOW(),
    is_active BOOLEAN DEFAULT true,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Logging Table: `sendgrid_operation_logs`**
```sql
CREATE TABLE sendgrid_operation_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    agent_id UUID,
    sendgrid_config_id UUID NOT NULL,
    operation_type TEXT NOT NULL,
    operation_params JSONB,
    operation_result JSONB,
    status TEXT DEFAULT 'success',
    error_message TEXT,
    sendgrid_message_id TEXT,
    recipients_count INTEGER DEFAULT 1,
    execution_time_ms INTEGER DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2. API Key Integration Pattern (Web Search)

**Primary Table: `user_oauth_connections` (with credential_type = 'api_key')**
```sql
CREATE TABLE user_oauth_connections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id),
    oauth_provider_id UUID NOT NULL REFERENCES oauth_providers(id),
    external_user_id TEXT NOT NULL,
    external_username TEXT,
    connection_name TEXT,
    vault_access_token_id TEXT,  -- Encrypted API key
    vault_refresh_token_id TEXT,
    encrypted_access_token TEXT,
    encrypted_refresh_token TEXT,
    scopes_granted JSONB,
    connection_status TEXT DEFAULT 'active',
    connection_metadata JSONB DEFAULT '{}',
    token_expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    credential_type connection_credential_type_enum DEFAULT 'oauth'
);
```

**Permission Table: `agent_oauth_permissions`**
```sql
CREATE TABLE agent_oauth_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL,
    user_oauth_connection_id UUID NOT NULL,
    granted_by_user_id UUID NOT NULL,
    permission_level TEXT DEFAULT 'read_only',
    allowed_scopes JSONB,
    granted_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT true,
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3. OAuth Provider Registry

**Table: `oauth_providers`**
```sql
CREATE TABLE oauth_providers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT UNIQUE NOT NULL,
    display_name TEXT NOT NULL,
    provider_type TEXT NOT NULL,  -- 'oauth' or 'api_key'
    auth_url TEXT,
    token_url TEXT,
    scope_separator TEXT DEFAULT ' ',
    default_scopes JSONB,
    configuration JSONB DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

## SMTP Schema Design Recommendations

Based on the analysis, SMTP should follow the **hybrid pattern** combining both approaches:

### Recommended SMTP Schema

#### 1. Provider Registration
```sql
-- Add SMTP to oauth_providers
INSERT INTO oauth_providers (name, display_name, provider_type) VALUES
('smtp', 'SMTP Email', 'api_key');
```

#### 2. SMTP Configurations (Detailed Settings)
```sql
CREATE TABLE smtp_configurations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id),
    connection_name TEXT NOT NULL,
    
    -- SMTP Server Settings
    host TEXT NOT NULL,
    port INTEGER NOT NULL DEFAULT 587,
    secure BOOLEAN NOT NULL DEFAULT false,  -- true for SSL, false for TLS
    
    -- Authentication
    username TEXT NOT NULL,
    vault_password_id TEXT NOT NULL,  -- Encrypted password/API key
    
    -- Email Defaults
    from_email TEXT NOT NULL,
    from_name TEXT,
    reply_to_email TEXT,
    
    -- Connection Settings
    connection_timeout INTEGER DEFAULT 60000,  -- milliseconds
    socket_timeout INTEGER DEFAULT 60000,
    greeting_timeout INTEGER DEFAULT 30000,
    
    -- Rate Limiting
    max_emails_per_day INTEGER DEFAULT 100,
    max_recipients_per_email INTEGER DEFAULT 50,
    
    -- Status
    is_active BOOLEAN DEFAULT true,
    last_tested_at TIMESTAMPTZ,
    test_status TEXT DEFAULT 'pending',  -- 'success', 'failed', 'pending'
    test_error_message TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT smtp_configurations_port_check CHECK (port BETWEEN 1 AND 65535),
    CONSTRAINT smtp_configurations_test_status_check CHECK (test_status IN ('success', 'failed', 'pending'))
);
```

#### 3. User OAuth Connections (API Key Storage)
```sql
-- Use existing user_oauth_connections table with:
-- credential_type = 'api_key'
-- vault_access_token_id = reference to smtp_configurations.id
-- This provides consistency with other API key integrations
```

#### 4. Agent Permissions
```sql
CREATE TABLE agent_smtp_permissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES agents(id),
    smtp_config_id UUID NOT NULL REFERENCES smtp_configurations(id),
    
    -- Permissions
    can_send_email BOOLEAN DEFAULT true,
    can_send_attachments BOOLEAN DEFAULT false,
    can_use_custom_from BOOLEAN DEFAULT false,
    
    -- Rate Limits (override config defaults)
    daily_email_limit INTEGER,  -- NULL = use config default
    recipients_per_email_limit INTEGER,  -- NULL = use config default
    
    -- Restrictions
    allowed_recipients JSONB,  -- Array of allowed email patterns
    blocked_recipients JSONB,  -- Array of blocked email patterns
    
    -- Metadata
    granted_by UUID NOT NULL REFERENCES auth.users(id),
    granted_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ,
    is_active BOOLEAN DEFAULT true,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### 5. Operation Logging
```sql
CREATE TABLE smtp_operation_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES auth.users(id),
    agent_id UUID REFERENCES agents(id),
    smtp_config_id UUID NOT NULL REFERENCES smtp_configurations(id),
    
    -- Operation Details
    operation_type TEXT NOT NULL,  -- 'send_email', 'test_connection'
    operation_params JSONB,  -- Input parameters
    operation_result JSONB,  -- Response data
    
    -- Email Details (for send_email operations)
    recipients_count INTEGER DEFAULT 0,
    has_attachments BOOLEAN DEFAULT false,
    email_size_bytes INTEGER,
    
    -- Status
    status TEXT NOT NULL DEFAULT 'success',  -- 'success', 'error', 'timeout'
    error_message TEXT,
    error_code TEXT,
    
    -- Performance
    execution_time_ms INTEGER DEFAULT 0,
    retry_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT smtp_operation_logs_status_check CHECK (status IN ('success', 'error', 'timeout'))
);
```

### RLS Policies Required

```sql
-- smtp_configurations policies
CREATE POLICY "Users can manage their own SMTP configs" ON smtp_configurations
    FOR ALL USING (user_id = auth.uid());

-- agent_smtp_permissions policies  
CREATE POLICY "Users can manage permissions for their agents" ON agent_smtp_permissions
    FOR ALL USING (
        granted_by = auth.uid() OR 
        EXISTS (SELECT 1 FROM agents WHERE id = agent_id AND user_id = auth.uid())
    );

-- smtp_operation_logs policies
CREATE POLICY "Users can view their own SMTP logs" ON smtp_operation_logs
    FOR SELECT USING (user_id = auth.uid());
```

### Helper Functions Required

```sql
-- Get SMTP tools for agent
CREATE OR REPLACE FUNCTION get_smtp_tools(p_agent_id UUID, p_user_id UUID)
RETURNS JSONB;

-- Validate agent SMTP permissions
CREATE OR REPLACE FUNCTION validate_agent_smtp_permissions(
    p_agent_id UUID, 
    p_user_id UUID, 
    p_smtp_config_id UUID
) RETURNS BOOLEAN;

-- Log SMTP operation
CREATE OR REPLACE FUNCTION log_smtp_operation(
    p_agent_id UUID,
    p_user_id UUID,
    p_smtp_config_id UUID,
    p_operation_type TEXT,
    p_operation_params JSONB DEFAULT NULL,
    p_operation_result JSONB DEFAULT NULL,
    p_status TEXT DEFAULT 'success',
    p_error_message TEXT DEFAULT NULL,
    p_recipients_count INTEGER DEFAULT 0,
    p_execution_time_ms INTEGER DEFAULT 0
) RETURNS UUID;
```

## Key Design Decisions

### 1. Hybrid Architecture
- **Primary Storage**: Dedicated `smtp_configurations` table for SMTP-specific settings
- **Integration Layer**: Use `user_oauth_connections` for consistency with other API key integrations
- **Permission System**: Dedicated `agent_smtp_permissions` for granular control

### 2. Security Approach
- **Credential Encryption**: All passwords stored in Supabase Vault
- **RLS Policies**: Strict user-based access control
- **Audit Logging**: Comprehensive operation tracking

### 3. Scalability Considerations
- **Multiple Configurations**: Users can have multiple SMTP configurations
- **Rate Limiting**: Built-in daily and per-email limits
- **Performance Tracking**: Execution time and retry monitoring

### 4. Consistency with Existing Patterns
- **Follows SendGrid pattern** for email-specific functionality
- **Follows Web Search pattern** for API key management
- **Uses existing OAuth provider registry** for integration catalog

## Implementation Priority

1. **Phase 1**: Create core tables (`smtp_configurations`, `agent_smtp_permissions`, `smtp_operation_logs`)
2. **Phase 2**: Add SMTP provider to `oauth_providers` and create RLS policies
3. **Phase 3**: Implement helper functions for tool integration
4. **Phase 4**: Create indexes and performance optimizations

This schema design provides a robust foundation for SMTP integration while maintaining consistency with existing Agentopia patterns.
