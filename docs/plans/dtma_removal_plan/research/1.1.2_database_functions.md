# Database Functions Research - DTMA Table References

**Task:** 1.1.2 Identify all database functions referencing DTMA tables  
**Date:** 06/25/2025  
**Researcher:** AI Assistant  
**Purpose:** Catalog all database functions that must be removed before DTMA table removal  

## **Critical Database Functions Found**

### **1. MCP Database Functions (20250607000003_add_mcp_database_functions.sql)**

**Functions that directly reference DTMA tables:**

#### **get_agent_mcp_servers(p_agent_id UUID)**
- **References:** `account_tool_instances`, `agent_mcp_server_access`
- **Purpose:** Returns MCP servers accessible to an agent
- **Risk Level:** HIGH - Core MCP functionality, must be removed

#### **get_available_mcp_servers(p_user_id UUID)**
- **References:** `account_tool_instances`, `account_tool_environments`
- **Purpose:** Lists available MCP servers for a user
- **Risk Level:** HIGH - Core toolbox functionality, must be removed

#### **grant_agent_mcp_access(p_agent_id, p_instance_id, ...)**
- **References:** `account_tool_instances`, `account_tool_environments`, `agent_mcp_server_access`
- **Purpose:** Grants agent access to MCP server instances
- **Risk Level:** HIGH - Modifies DTMA tables, must be removed

#### **revoke_agent_mcp_access(p_agent_id, p_instance_id)**
- **References:** `agent_mcp_server_access`
- **Purpose:** Revokes agent access to MCP server instances
- **Risk Level:** HIGH - Modifies DTMA tables, must be removed

### **2. Trigger Functions on DTMA Tables**

From migration analysis, these triggers exist on DTMA tables:

#### **set_tool_catalog_updated_at**
- **Table:** `tool_catalog`
- **Purpose:** Updates timestamp on record changes
- **Risk Level:** MEDIUM - Must be dropped before table removal

#### **set_agent_toolbox_access_updated_at**
- **Table:** `agent_toolbox_access`
- **Purpose:** Updates timestamp on record changes
- **Risk Level:** MEDIUM - Must be dropped before table removal

#### **set_agent_toolbelt_items_updated_at**
- **Table:** `agent_toolbelt_items`
- **Purpose:** Updates timestamp on record changes
- **Risk Level:** MEDIUM - Must be dropped before table removal

### **3. Utility Functions (May Reference DTMA Tables)**

#### **trigger_set_timestamp()**
- **Usage:** Generic timestamp trigger function
- **Risk Level:** LOW - Shared function, verify usage before removal

## **Functions That Do NOT Reference DTMA Tables**

These functions are safe to keep (no DTMA table references):
- `get_user_oauth_connections()`
- `grant_agent_oauth_access()`
- `get_agent_oauth_permissions()`
- `record_agent_oauth_usage()`
- All workspace/chat related functions
- All user/profile management functions

## **Removal Order for Functions**

```sql
-- PHASE 1: Drop MCP-specific functions first
DROP FUNCTION IF EXISTS public.get_agent_mcp_servers(UUID);
DROP FUNCTION IF EXISTS public.get_available_mcp_servers(UUID);
DROP FUNCTION IF EXISTS public.grant_agent_mcp_access(UUID, UUID, TEXT, JSONB, TIMESTAMPTZ);
DROP FUNCTION IF EXISTS public.revoke_agent_mcp_access(UUID, UUID);

-- PHASE 2: Drop triggers on DTMA tables
DROP TRIGGER IF EXISTS set_tool_catalog_updated_at ON public.tool_catalog;
DROP TRIGGER IF EXISTS set_agent_toolbox_access_updated_at ON public.agent_toolbox_access;
DROP TRIGGER IF EXISTS set_agent_toolbelt_items_updated_at ON public.agent_toolbelt_items;

-- PHASE 3: Then proceed with table removal (from previous research)
```

## **Supabase Edge Functions Analysis**

**DTMA-Related Edge Functions Found:**
- `toolbox-dtma-console/` - Complete function for DTMA management
- `toolboxes-user/` - User toolbox operations
- `toolbox-tools/` - Toolbox tool management
- `manage-agent-tool-environment/` - Environment management

**Risk Assessment:** These Edge Functions likely call the database functions above and reference DTMA tables directly. They must be removed before database function removal.

## **Risk Mitigation Strategy**

### **HIGH RISK**
- **Function Dependencies:** Some functions may be called by frontend code
- **Data Integrity:** Functions that modify data need transaction safety
- **Cascade Effects:** Removing functions may break Edge Functions

### **MITIGATION STEPS**
1. **Search frontend code** for function calls before removal
2. **Remove Edge Functions first** before database functions
3. **Use transaction blocks** for all function removals
4. **Test function removal** on development database first

## **Implementation Notes**

### **Function Removal SQL Template:**
```sql
BEGIN;

-- Remove functions in dependency order
DROP FUNCTION IF EXISTS public.function_name(param_types);

-- Verify removal
SELECT proname FROM pg_proc WHERE proname LIKE '%mcp%' OR proname LIKE '%toolbox%';

COMMIT;
```

### **Verification Queries:**
```sql
-- Check for remaining DTMA-related functions
SELECT proname, prosrc 
FROM pg_proc 
WHERE prosrc LIKE '%account_tool_%' 
   OR prosrc LIKE '%tool_catalog%'
   OR proname LIKE '%mcp%'
   OR proname LIKE '%toolbox%';

-- Check for remaining triggers on DTMA tables
SELECT schemaname, tablename, triggername 
FROM pg_triggers 
WHERE tablename IN (
    'account_tool_environments',
    'account_tool_instances', 
    'tool_catalog',
    'agent_toolbox_access'
);
```

## **Backup Requirements**

Before function removal:
1. **Export function definitions:** `pg_dump --schema-only --table=functions`
2. **Document function usage:** Search codebase for function calls
3. **Create rollback script:** Script to recreate all functions if needed

**Status:** âœ… **COMPLETE** - Ready to proceed to RLS policies research  
**Risk Level:** HIGH - Functions are actively used by MCP system 