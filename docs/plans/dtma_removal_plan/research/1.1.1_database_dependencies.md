# Database Dependencies Research - DTMA Table Removal

**Task:** 1.1.1 Map all foreign key relationships involving DTMA tables  
**Date:** 06/25/2025  
**Researcher:** AI Assistant  
**Purpose:** Understand database dependency chain for safe table removal order  

## **Critical Foreign Key Dependencies Discovered**

### **1. account_tool_environments (Primary Parent Table)**
**Referenced by:**
- `account_tool_instances.account_tool_environment_id` → **CASCADE DELETE**
- `agent_toolbox_access.account_tool_environment_id` → **CASCADE DELETE**

**Analysis:** This is the primary parent table. When we remove it, the CASCADE DELETE constraints will automatically remove related records in child tables. This is GOOD for cleanup but we must ensure child tables are removed first to avoid orphaned data.

### **2. account_tool_instances (Secondary Parent Table)**  
**Referenced by:**
- `agent_mcp_server_access.account_tool_instance_id` → **CASCADE DELETE**
- `agent_toolbelt_items.account_tool_instance_id` → **CASCADE DELETE**
- `mcp_server_endpoints.account_tool_instance_id` → **CASCADE DELETE**
- `agent_mcp_connections.mcp_server_instance_id` → **CASCADE DELETE**
- `mcp_connection_logs.server_id` → **CASCADE DELETE**

**Analysis:** This table has multiple child tables referencing it. The CASCADE DELETE will handle cleanup, but we need to verify these child tables exist and understand their purpose.

### **3. tool_catalog (Reference Table)**
**Referenced by:**
- `account_tool_instances.tool_catalog_id` → **RESTRICT DELETE**
- `agent_droplet_tools.tool_catalog_id` → **RESTRICT DELETE**

**Analysis:** ⚠️ **CRITICAL** - This has RESTRICT DELETE constraints, meaning we cannot delete tool_catalog records if they're referenced by other tables. We must remove all referencing records first.

## **Safe Removal Order (Based on Dependencies)**

```sql
-- PHASE 1: Remove leaf tables (no dependencies on them)
1. DROP TABLE mcp_connection_logs;
2. DROP TABLE agent_mcp_connections;  
3. DROP TABLE mcp_server_endpoints;
4. DROP TABLE agent_mcp_server_access;
5. DROP TABLE agent_toolbelt_items;

-- PHASE 2: Remove secondary parent tables
6. DROP TABLE agent_toolbox_access;
7. DROP TABLE account_tool_instances;

-- PHASE 3: Remove primary parent table  
8. DROP TABLE account_tool_environments;

-- PHASE 4: Remove reference table (after all references are gone)
9. DROP TABLE tool_catalog;
```

## **Risk Assessment**

### **HIGH RISK**
- **RESTRICT DELETE constraints on tool_catalog:** Must verify no references exist before deletion
- **Data Loss:** CASCADE DELETE will remove all related data - ensure backups exist

### **MEDIUM RISK**  
- **Hidden Dependencies:** Some tables may have triggers or functions referencing these tables
- **Application References:** Frontend/backend code may still reference these tables

### **MITIGATION STRATEGIES**

1. **Create comprehensive database backup** before any removal
2. **Use transaction-based removal** with rollback capability  
3. **Verify no data exists** in any DTMA tables before removal
4. **Test removal on development database** first

## **Additional Tables to Investigate**

From the search results, these tables also reference DTMA components:
- `agent_droplet_tools` - References tool_catalog
- `mcp_server_endpoints` - References account_tool_instances

**Next Action:** Research these additional tables to ensure complete dependency mapping.

## **Backup Requirements**

Before proceeding with any removals:
1. **Full database dump:** `supabase db dump --linked`
2. **Table-specific backups:** Individual table exports
3. **Schema-only backup:** Structure without data for rollback reference

## **Implementation Notes**

- Use `BEGIN;` and `COMMIT;` transaction blocks for safe execution
- Test each DROP statement individually with `--dry-run` equivalent
- Verify foreign key constraints are actually dropped with each table removal
- Monitor for any constraint violation errors during removal process

**Status:** ✅ **COMPLETE** - Ready to proceed to next research task  
**Risk Level:** HIGH - Requires careful execution with full backups 