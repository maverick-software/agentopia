# Research: API Design

## Task: 3.2 API Design

### Research Objective
Design comprehensive API endpoints, request/response schemas, and error handling for the advanced JSON-based chat system that supports structured communication, memory management, and state persistence.

## Current API Analysis

### Existing Endpoints
Based on current implementation:
- **POST /chat**: Main chat endpoint
  - Simple request format: `{message, agentId, channelId, workspaceId}`
  - Simple response format: `{message, agent: {id, name}}`
  - No versioning support
  - Limited error information

### Current Limitations
1. **No Structured Data Support**: Plain text messages only
2. **No Streaming**: Full response only
3. **No Batch Operations**: Single message processing
4. **Limited Error Details**: Generic error messages
5. **No Rate Limit Info**: Hidden from client
6. **No Metrics**: No performance data returned

## Industry Best Practices

### RESTful API Design
1. **Versioning**
   - URL path: `/v2/chat`
   - Header: `X-API-Version: 2.0`
   - Content negotiation: `Accept: application/vnd.agentopia.v2+json`

2. **Resource-Oriented**
   - Resources: conversations, messages, memories, states
   - Clear hierarchies: `/conversations/{id}/messages`
   - Consistent naming: plural nouns

3. **HTTP Methods**
   - POST: Create resources
   - GET: Retrieve resources
   - PATCH: Partial updates
   - DELETE: Remove resources

### OpenAI API Patterns
```typescript
// Structured request
{
  "model": "gpt-4",
  "messages": [...],
  "tools": [...],
  "tool_choice": "auto",
  "stream": false,
  "max_tokens": 1000,
  "temperature": 0.7
}

// Structured response
{
  "id": "chatcmpl-xxx",
  "object": "chat.completion",
  "created": 1234567890,
  "model": "gpt-4",
  "usage": {...},
  "choices": [...]
}
```

### Anthropic Claude API
- Message-based structure
- System/user/assistant roles
- Metadata support
- Token counting
- Streaming with SSE

### Error Standards (RFC 7807)
```json
{
  "type": "https://api.agentopia.com/errors/rate-limit",
  "title": "Rate limit exceeded",
  "status": 429,
  "detail": "You have exceeded the rate limit of 30 requests per minute",
  "instance": "/v2/chat/messages",
  "extensions": {
    "limit": 30,
    "remaining": 0,
    "reset": 1234567890
  }
}
```

## Proposed API Design

### Core Endpoints

#### 1. Chat Endpoints
```typescript
// Create message
POST /v2/chat/messages
Content-Type: application/json
X-API-Version: 2.0

// Stream message
POST /v2/chat/messages/stream
Content-Type: application/json
Accept: text/event-stream

// Get message
GET /v2/chat/messages/{messageId}

// Update message metadata
PATCH /v2/chat/messages/{messageId}/metadata

// Get message versions
GET /v2/chat/messages/{messageId}/versions
```

#### 2. Conversation Endpoints
```typescript
// Create conversation
POST /v2/conversations

// Get conversation
GET /v2/conversations/{conversationId}

// List conversations
GET /v2/conversations?agent_id={agentId}&limit=20

// Get conversation messages
GET /v2/conversations/{conversationId}/messages

// Update conversation
PATCH /v2/conversations/{conversationId}

// Close conversation
POST /v2/conversations/{conversationId}/close
```

#### 3. Memory Endpoints
```typescript
// Create memory
POST /v2/agents/{agentId}/memories

// Search memories
POST /v2/agents/{agentId}/memories/search

// Get memory
GET /v2/memories/{memoryId}

// Update memory importance
PATCH /v2/memories/{memoryId}/importance

// Consolidate memories
POST /v2/agents/{agentId}/memories/consolidate
```

#### 4. State Endpoints
```typescript
// Get current state
GET /v2/agents/{agentId}/state

// Create checkpoint
POST /v2/agents/{agentId}/state/checkpoints

// Restore from checkpoint
POST /v2/agents/{agentId}/state/restore

// Get state history
GET /v2/agents/{agentId}/state/history

// Update state
PATCH /v2/agents/{agentId}/state
```

#### 5. Context Endpoints
```typescript
// Get context snapshot
GET /v2/messages/{messageId}/context

// Create context template
POST /v2/context/templates

// Apply context template
POST /v2/conversations/{conversationId}/context/apply

// Optimize context
POST /v2/conversations/{conversationId}/context/optimize
```

### Request Schemas

#### Create Message Request
```typescript
interface CreateMessageRequest {
  // API version
  version: '2.0.0';
  
  // Message content
  message: {
    role: MessageRole;
    content: MessageContent;
    metadata?: Partial<MessageMetadata>;
    tools?: ToolCall[];
    memory_refs?: string[];
  };
  
  // Context
  context: {
    conversation_id?: string;
    session_id?: string;
    agent_id?: string;
    channel_id?: string;
    workspace_id?: string;
  };
  
  // Options
  options?: {
    // Memory options
    memory?: {
      enabled: boolean;
      types: MemoryType[];
      max_results: number;
      min_relevance: number;
    };
    
    // State options
    state?: {
      save_checkpoint: boolean;
      include_shared: boolean;
    };
    
    // Response options
    response?: {
      stream: boolean;
      include_metadata: boolean;
      include_metrics: boolean;
      max_tokens?: number;
      temperature?: number;
    };
    
    // Tool options
    tools?: {
      enabled: boolean;
      parallel_execution: boolean;
      timeout_ms: number;
    };
  };
}
```

#### Batch Message Request
```typescript
interface BatchMessageRequest {
  version: '2.0.0';
  
  // Multiple messages for processing
  messages: Array<{
    id: string; // Client-provided ID for correlation
    message: CreateMessageRequest['message'];
    context: CreateMessageRequest['context'];
    options?: CreateMessageRequest['options'];
  }>;
  
  // Batch options
  batch_options: {
    parallel_processing: boolean;
    stop_on_error: boolean;
    max_concurrent: number;
  };
}
```

### Response Schemas

#### Message Response
```typescript
interface MessageResponse {
  // Response metadata
  version: '2.0.0';
  status: 'success' | 'error' | 'partial';
  
  // Message data
  data: {
    message: AdvancedChatMessage;
    
    // Conversation info
    conversation: {
      id: string;
      message_count: number;
      created_at: string;
      updated_at: string;
    };
    
    // Session info
    session: {
      id: string;
      active: boolean;
      duration_ms: number;
    };
  };
  
  // Performance metrics
  metrics?: {
    processing_time_ms: number;
    tokens: {
      prompt: number;
      completion: number;
      total: number;
    };
    model: string;
    memory_searches: number;
    tool_executions: number;
  };
  
  // Pagination (for list endpoints)
  pagination?: {
    total: number;
    offset: number;
    limit: number;
    has_more: boolean;
  };
  
  // Links (HATEOAS)
  links?: {
    self: string;
    conversation: string;
    next_message?: string;
    previous_message?: string;
  };
}
```

#### Streaming Response (SSE Format)
```typescript
// Event: message_start
data: {
  "event": "message_start",
  "message_id": "msg_123",
  "timestamp": "2024-01-20T10:00:00Z"
}

// Event: content_delta
data: {
  "event": "content_delta",
  "delta": "Hello, ",
  "index": 0
}

// Event: tool_call
data: {
  "event": "tool_call",
  "tool": "search_email",
  "status": "executing"
}

// Event: message_complete
data: {
  "event": "message_complete",
  "message": {...},
  "metrics": {...}
}

// Event: error
data: {
  "event": "error",
  "error": {...}
}
```

### Error Response Schemas

#### Standard Error Response
```typescript
interface ErrorResponse {
  // RFC 7807 fields
  type: string;        // URI reference
  title: string;       // Short summary
  status: number;      // HTTP status code
  detail: string;      // Detailed explanation
  instance: string;    // Specific occurrence
  
  // Extensions
  error_code: string;  // Machine-readable code
  timestamp: string;   // When error occurred
  request_id: string;  // For debugging
  
  // Additional context
  extensions?: {
    // Validation errors
    validation_errors?: Array<{
      field: string;
      message: string;
      code: string;
    }>;
    
    // Rate limit info
    rate_limit?: {
      limit: number;
      remaining: number;
      reset: number;
    };
    
    // Suggested actions
    suggestions?: string[];
    
    // Help links
    documentation?: string;
    support?: string;
  };
}
```

#### Error Codes
```typescript
enum ErrorCode {
  // Client errors (4xx)
  INVALID_REQUEST = 'invalid_request',
  INVALID_MESSAGE_FORMAT = 'invalid_message_format',
  MISSING_REQUIRED_FIELD = 'missing_required_field',
  INVALID_API_VERSION = 'invalid_api_version',
  RATE_LIMIT_EXCEEDED = 'rate_limit_exceeded',
  QUOTA_EXCEEDED = 'quota_exceeded',
  AUTHENTICATION_FAILED = 'authentication_failed',
  INSUFFICIENT_PERMISSIONS = 'insufficient_permissions',
  RESOURCE_NOT_FOUND = 'resource_not_found',
  CONFLICT = 'conflict',
  
  // Server errors (5xx)
  INTERNAL_ERROR = 'internal_error',
  SERVICE_UNAVAILABLE = 'service_unavailable',
  DEPENDENCY_ERROR = 'dependency_error',
  TIMEOUT = 'timeout',
  
  // Business logic errors
  AGENT_NOT_FOUND = 'agent_not_found',
  CONVERSATION_CLOSED = 'conversation_closed',
  MEMORY_LIMIT_EXCEEDED = 'memory_limit_exceeded',
  STATE_CORRUPTION = 'state_corruption',
  TOOL_EXECUTION_FAILED = 'tool_execution_failed',
}
```

### API Behaviors

#### Content Negotiation
```typescript
// Request headers
Accept: application/json          // JSON response
Accept: application/vnd.agentopia.v2+json  // Version-specific
Accept: text/event-stream        // SSE streaming

// Response headers
Content-Type: application/json; charset=utf-8
X-API-Version: 2.0
X-Request-ID: req_abc123
X-Response-Time: 245ms
```

#### Rate Limiting
```typescript
// Response headers
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 99
X-RateLimit-Reset: 1640995200
X-RateLimit-Policy: sliding-window
Retry-After: 60  // When rate limited
```

#### Pagination
```typescript
// Request
GET /v2/conversations?limit=20&offset=40

// Response headers
X-Total-Count: 150
Link: <...?offset=20>; rel="prev", <...?offset=60>; rel="next"
```

#### Caching
```typescript
// Response headers
Cache-Control: private, max-age=300
ETag: "686897696a7c8761"
Last-Modified: Sat, 20 Jan 2024 10:00:00 GMT

// Conditional requests
If-None-Match: "686897696a7c8761"
If-Modified-Since: Sat, 20 Jan 2024 10:00:00 GMT
```

### Authentication & Authorization

#### Authentication Methods
1. **Bearer Token** (JWT)
   ```
   Authorization: Bearer eyJhbGciOiJ...
   ```

2. **API Key**
   ```
   X-API-Key: sk_live_abc123...
   ```

3. **OAuth 2.0**
   - Authorization code flow
   - Client credentials flow

#### Permission Scopes
```typescript
enum Scope {
  // Message operations
  'messages:read',
  'messages:write',
  
  // Memory operations
  'memories:read',
  'memories:write',
  'memories:delete',
  
  // State operations
  'state:read',
  'state:write',
  
  // Admin operations
  'admin:read',
  'admin:write',
}
```

### SDK Considerations

#### TypeScript SDK
```typescript
// Client initialization
const client = new AgentopiaClient({
  apiKey: process.env.AGENTOPIA_API_KEY,
  version: '2.0',
  timeout: 30000,
  retries: 3,
});

// Type-safe operations
const response = await client.chat.messages.create({
  message: {
    role: 'user',
    content: { type: 'text', text: 'Hello!' }
  },
  context: { agent_id: 'agent_123' }
});

// Streaming
const stream = await client.chat.messages.stream({...});
for await (const chunk of stream) {
  console.log(chunk.delta);
}
```

#### Error Handling
```typescript
try {
  const response = await client.chat.messages.create({...});
} catch (error) {
  if (error instanceof RateLimitError) {
    // Wait and retry
    await sleep(error.retryAfter);
  } else if (error instanceof ValidationError) {
    // Fix validation issues
    console.error(error.validationErrors);
  } else {
    // Handle other errors
    throw error;
  }
}
```

## Migration Strategy

### Deprecation Timeline
1. **Month 1-2**: V1 and V2 parallel operation
2. **Month 3-4**: V1 deprecation warnings
3. **Month 5-6**: V1 read-only mode
4. **Month 7**: V1 shutdown

### Migration Helpers
```typescript
// Automatic version upgrade
POST /v2/migrate
{
  "from_version": "1.0",
  "conversation_ids": [...],
  "dry_run": true
}

// Migration status
GET /v2/migration/status
{
  "v1_requests_24h": 1000,
  "v2_requests_24h": 5000,
  "migration_progress": 0.83,
  "estimated_completion": "2024-06-01"
}
```

## Testing Requirements

### Contract Testing
- Request/response schema validation
- Backward compatibility checks
- Error response consistency
- Header validation

### Performance Testing
- Latency targets: p50 < 200ms, p99 < 1s
- Throughput: 1000 req/s per instance
- Concurrent connections: 10,000
- Streaming performance

### Security Testing
- Authentication bypass attempts
- Rate limit circumvention
- Injection attacks
- CORS validation

## Documentation Requirements

### OpenAPI Specification
- Complete OpenAPI 3.0 spec
- Request/response examples
- Error scenarios
- Authentication flows

### Developer Guide
- Quick start guide
- SDK examples
- Common patterns
- Troubleshooting

### API Reference
- Endpoint documentation
- Parameter descriptions
- Response codes
- Rate limits

## Monitoring & Analytics

### Key Metrics
- Request volume by endpoint
- Response times by percentile
- Error rates by type
- Token usage
- Feature adoption

### Alerts
- Error rate > 1%
- Response time > 2s (p99)
- Rate limit breaches
- Authentication failures
- Dependency failures

## Next Steps

1. Finalize endpoint designs
2. Create OpenAPI specification
3. Implement request validation
4. Build response serialization
5. Add monitoring instrumentation
6. Write comprehensive tests
7. Generate SDK code
8. Create documentation

## References
- RESTful API Design Best Practices
- OpenAI API Documentation
- Anthropic Claude API Reference
- RFC 7807 - Problem Details for HTTP APIs
- JSON:API Specification
- GraphQL vs REST Considerations